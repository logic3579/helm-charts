# ArgoCD AppProject for Prod Environment
# This project manages all applications deployed to the Prod GKE cluster
#
# Usage:
#   cp prod-project.yaml.example prod-project.yaml
#   # Edit the file to replace placeholders with actual values
#   kubectl apply -f prod-project.yaml

apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: example-prod
  namespace: argocd
  finalizers:
    - argocd.argoproj.io/resources-finalizer
spec:
  description: "Example Production Environment - Manual sync only (PR approval required)"

  # Source repositories - replace with your repo URL
  sourceRepos:
    - "https://github.com/<YOUR_ORG>/<YOUR_REPO>.git"

  # Destination cluster - use cluster name from cluster secret
  destinations:
    - name: prod-cluster
      namespace: "*"

  # Cluster resources allowed to be deployed
  clusterResourceWhitelist:
    - group: "*"
      kind: "*"

  # Namespace resources allowed
  namespaceResourceWhitelist:
    - group: "*"
      kind: "*"

  # Roles for this project
  roles:
    # Admin role - full access (only DevOps team)
    - name: admin
      description: "Full access to production project"
      policies:
        - p, proj:example-prod:admin, applications, *, example-prod/*, allow
        - p, proj:example-prod:admin, clusters, get, example-prod/*, allow
        - p, proj:example-prod:admin, repositories, get, example-prod/*, allow
        - p, proj:example-prod:admin, logs, get, example-prod/*, allow
      groups:
        - devops-team

    # Developer role - read-only (no sync for production)
    - name: dev
      description: "Read-only access to production applications"
      policies:
        - p, proj:example-prod:dev, applications, get, example-prod/*, allow
        - p, proj:example-prod:dev, logs, get, example-prod/*, allow
      groups:
        - developer-team

  # Orphaned resources monitoring
  orphanedResources:
    warn: true
    ignore:
      # Global helm chart ConfigMaps
      - kind: ConfigMap
        name: "global-*"
      # Istio auto-generated certificates
      - kind: ConfigMap
        name: "istio-ca-*"
      # Manually managed pull secret
      - kind: Secret
        name: "github-registry-secret"
      # Manually managed ServiceAccount
      - kind: ServiceAccount
        name: "app"

  # Signature keys for verified commits (optional)
  # signatureKeys:
  #   - keyID: <GPG_KEY_ID>
